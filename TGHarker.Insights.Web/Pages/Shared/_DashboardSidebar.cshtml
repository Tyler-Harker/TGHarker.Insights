@using TGHarker.Insights.Web.Pages.Dashboard
@model DashboardPageModel

@{
    var currentPage = Model.CurrentPage;

    // Get organization info
    var selectedOrgJson = User.FindFirst("organization")?.Value;
    var orgsJson = User.FindFirst("organizations")?.Value;
    string? currentOrgId = null;
    string? currentOrgName = null;
    var organizations = new List<(string Id, string Name)>();

    if (!string.IsNullOrEmpty(selectedOrgJson))
    {
        try
        {
            var doc = System.Text.Json.JsonDocument.Parse(selectedOrgJson);
            if (doc.RootElement.TryGetProperty("id", out var idProp))
                currentOrgId = idProp.GetString();
            if (doc.RootElement.TryGetProperty("name", out var nameProp))
                currentOrgName = nameProp.GetString();
        }
        catch { }
    }

    if (!string.IsNullOrEmpty(orgsJson))
    {
        try
        {
            var arr = System.Text.Json.JsonDocument.Parse(orgsJson).RootElement;
            foreach (var org in arr.EnumerateArray())
            {
                var id = org.TryGetProperty("id", out var idProp) ? idProp.GetString() : null;
                var name = org.TryGetProperty("name", out var nameProp) ? nameProp.GetString() : null;
                if (id != null && name != null)
                    organizations.Add((id, name));
            }
        }
        catch { }
    }
}

<!-- Application Switcher -->
<div class="app-switcher-sidebar p-3 border-bottom">
    <div class="dropdown w-100">
        <button class="btn btn-outline-secondary w-100 text-start d-flex align-items-center justify-content-between" type="button" data-bs-toggle="dropdown">
            <div class="d-flex align-items-center gap-2 overflow-hidden">
                <i class="bi bi-globe"></i>
                <span class="text-truncate">@Model.Application?.Name</span>
            </div>
            <i class="bi bi-chevron-down small"></i>
        </button>
        <ul class="dropdown-menu w-100 shadow">
            <li><h6 class="dropdown-header">Your Applications</h6></li>
            @foreach (var app in Model.AllApplications)
            {
                var appId = app.Id.StartsWith("app-") ? app.Id[4..] : app.Id;
                var isActive = appId == Model.ApplicationId;
                <li>
                    <a class="dropdown-item d-flex flex-column @(isActive ? "active" : "")" href="/dashboard/applications/@appId">
                        <span class="fw-medium">@app.Name</span>
                        <small class="text-muted">@app.Domain</small>
                    </a>
                </li>
            }
            <li><hr class="dropdown-divider"></li>
            <li>
                <a class="dropdown-item d-flex align-items-center text-primary" href="/dashboard/new">
                    <i class="bi bi-plus-circle me-2"></i>Add Application
                </a>
            </li>
        </ul>
    </div>
</div>

<!-- Navigation -->
<div class="sidebar-section-title">Analytics</div>
<nav class="sidebar-nav nav flex-column">
    <a class="nav-link @(currentPage == "overview" ? "active" : "")" href="/dashboard/applications/@Model.ApplicationId">
        <i class="bi bi-speedometer2"></i>Overview
    </a>
    <a class="nav-link @(currentPage == "realtime" ? "active" : "")" href="/dashboard/applications/@Model.ApplicationId/realtime">
        <i class="bi bi-broadcast"></i>Real-time
    </a>
    <a class="nav-link @(currentPage == "pages" ? "active" : "")" href="/dashboard/applications/@Model.ApplicationId/pages">
        <i class="bi bi-file-earmark-text"></i>Pages
    </a>
    <a class="nav-link @(currentPage == "sources" ? "active" : "")" href="/dashboard/applications/@Model.ApplicationId/sources">
        <i class="bi bi-diagram-3"></i>Sources
    </a>
    <a class="nav-link @(currentPage == "events" ? "active" : "")" href="/dashboard/applications/@Model.ApplicationId/events">
        <i class="bi bi-cursor"></i>Events
    </a>
    <a class="nav-link @(currentPage == "conversions" ? "active" : "")" href="/dashboard/applications/@Model.ApplicationId/conversions">
        <i class="bi bi-bullseye"></i>Conversions
    </a>
    <a class="nav-link @(currentPage == "funnels" ? "active" : "")" href="/dashboard/applications/@Model.ApplicationId/funnels">
        <i class="bi bi-filter"></i>Funnels
    </a>
</nav>

<div class="sidebar-section-title">Configuration</div>
<nav class="sidebar-nav nav flex-column">
    <a class="nav-link @(currentPage == "settings" ? "active" : "")" href="/dashboard/applications/@Model.ApplicationId/settings">
        <i class="bi bi-gear"></i>Settings
    </a>
</nav>

<!-- Profile Section -->
<div class="sidebar-profile mt-auto">
    <div class="dropup w-100">
        <button class="btn btn-link text-decoration-none w-100 text-start p-3 d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <div class="profile-avatar">
                <i class="bi bi-person-fill"></i>
            </div>
            <div class="flex-grow-1 overflow-hidden">
                <div class="profile-name text-truncate">@User.Identity?.Name</div>
                <div class="profile-org text-truncate">@(currentOrgName ?? "No Organization")</div>
            </div>
            <i class="bi bi-chevron-up"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow w-100 mb-2">
            <li><h6 class="dropdown-header">Organization</h6></li>
            @foreach (var org in organizations)
            {
                var isActive = org.Id == currentOrgId;
                <li>
                    <a class="dropdown-item d-flex justify-content-between align-items-center @(isActive ? "active" : "")" href="/switch-org?organization_id=@org.Id">
                        @org.Name
                        @if (isActive)
                        {
                            <i class="bi bi-check"></i>
                        }
                    </a>
                </li>
            }
            <li><hr class="dropdown-divider"></li>
            <li>
                <a class="dropdown-item text-danger" href="/logout">
                    <i class="bi bi-box-arrow-right me-2"></i>Logout
                </a>
            </li>
        </ul>
    </div>
</div>
