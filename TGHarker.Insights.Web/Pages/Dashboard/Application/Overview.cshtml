@page "/dashboard/applications/{applicationId}"
@model TGHarker.Insights.Web.Pages.Dashboard.Application.OverviewModel
@{
    ViewData["Title"] = $"Dashboard - {Model.Application?.Name}";
    Layout = "_DashboardLayout";
}

<div class="d-flex justify-content-between align-items-start mb-4">
    <div class="page-header">
        <h4>Overview</h4>
        <p class="page-description">A high-level summary of your website's performance and visitor activity.</p>
    </div>
    <div class="d-flex gap-2">
        <div class="btn-group">
            @{
                var baseUrl = $"/dashboard/applications/{Model.ApplicationId}";
            }
            <a href="@(baseUrl)?range=30d" class="btn btn-outline-secondary btn-sm @(Model.Range == "30d" ? "active" : "")">Last 30 days</a>
            <a href="@(baseUrl)?range=7d" class="btn btn-outline-secondary btn-sm @(Model.Range == "7d" ? "active" : "")">Last 7 days</a>
            <a href="@(baseUrl)?range=24h" class="btn btn-outline-secondary btn-sm @(Model.Range == "24h" ? "active" : "")">Last 24 hours</a>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-label">Page Views</div>
            <div class="metric-value" id="metric-pageviews">
                <span class="placeholder-glow"><span class="placeholder col-6"></span></span>
            </div>
            <div class="metric-card-help">Total pages loaded by visitors</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-label">Sessions</div>
            <div class="metric-value" id="metric-sessions">
                <span class="placeholder-glow"><span class="placeholder col-6"></span></span>
            </div>
            <div class="metric-card-help">Individual visitor sessions</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-label">Bounce Rate</div>
            <div class="metric-value" id="metric-bouncerate">
                <span class="placeholder-glow"><span class="placeholder col-6"></span></span>
            </div>
            <div class="metric-card-help">Single-page visits without interaction</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-label">Avg. Duration</div>
            <div class="metric-value" id="metric-duration">
                <span class="placeholder-glow"><span class="placeholder col-6"></span></span>
            </div>
            <div class="metric-card-help">Average time spent per session</div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="chart-container">
            <h6 class="mb-3">Traffic Overview</h6>
            <div id="chart-loading" class="text-center py-4 text-muted">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                Loading chart data...
            </div>
            <canvas id="trafficChart" height="100" style="display: none;"></canvas>
        </div>
    </div>
</div>

<div class="row g-3">
    <div class="col-md-6">
        <div class="chart-container">
            <h6 class="mb-3">Top Pages</h6>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Page</th>
                        <th class="text-end">Views</th>
                    </tr>
                </thead>
                <tbody id="top-pages-body">
                    <tr>
                        <td colspan="2" class="text-center text-muted py-3">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            Loading...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <h6 class="mb-3">Traffic Sources</h6>
            <div id="sources-loading" class="text-center py-4 text-muted">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                Loading sources...
            </div>
            <canvas id="sourcesChart" height="150" style="display: none;"></canvas>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const applicationId = '@Model.ApplicationId';
    const range = '@Model.Range';
    let trafficChart = null;
    let sourcesChart = null;

    function formatNumber(num) {
        return new Intl.NumberFormat().format(num);
    }

    function formatDuration(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function updateMetrics(data) {
        document.getElementById('metric-pageviews').textContent = formatNumber(data.pageViews);
        document.getElementById('metric-sessions').textContent = formatNumber(data.sessions);
        document.getElementById('metric-bouncerate').textContent = data.bounceRate.toFixed(1) + '%';
        document.getElementById('metric-duration').textContent = formatDuration(data.avgSessionDuration);
    }

    function updateChart(data) {
        document.getElementById('chart-loading').style.display = 'none';
        const canvas = document.getElementById('trafficChart');
        canvas.style.display = 'block';

        let labels = data.labels;
        if (data.isHourly && data.timestamps && data.timestamps.length > 0) {
            labels = data.timestamps.map(ts => {
                const date = new Date(ts);
                return date.toLocaleTimeString([], { hour: 'numeric', hour12: true });
            });
        }

        trafficChart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Page Views',
                    data: data.data,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.15)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    function updateTopPages(pages) {
        const tbody = document.getElementById('top-pages-body');
        if (pages.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted py-3">No page views yet</td></tr>';
            return;
        }

        tbody.innerHTML = pages.slice(0, 5).map(page => `
            <tr>
                <td class="text-truncate" style="max-width: 200px;">${page.path}</td>
                <td class="text-end">${formatNumber(page.views)}</td>
            </tr>
        `).join('');
    }

    function updateSources(sources) {
        document.getElementById('sources-loading').style.display = 'none';
        const canvas = document.getElementById('sourcesChart');
        canvas.style.display = 'block';

        if (sources.length === 0) {
            canvas.style.display = 'none';
            document.getElementById('sources-loading').innerHTML = '<span class="text-muted">No source data yet</span>';
            document.getElementById('sources-loading').style.display = 'block';
            return;
        }

        sourcesChart = new Chart(canvas, {
            type: 'doughnut',
            data: {
                labels: sources.map(s => s.source),
                datasets: [{
                    data: sources.map(s => s.count),
                    backgroundColor: ['#3b82f6', '#2563eb', '#1d4ed8', '#1e40af', '#1e3a8a', '#172554']
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'right' } }
            }
        });
    }

    function initSSE() {
        const eventSource = new EventSource(`/api/applications/${applicationId}/analytics/stream?range=${range}`);

        eventSource.addEventListener('metrics', (e) => {
            const data = JSON.parse(e.data);
            updateMetrics(data);
        });

        eventSource.addEventListener('chart', (e) => {
            const data = JSON.parse(e.data);
            updateChart(data);
        });

        eventSource.addEventListener('topPages', (e) => {
            const data = JSON.parse(e.data);
            updateTopPages(data);
        });

        eventSource.addEventListener('sources', (e) => {
            const data = JSON.parse(e.data);
            updateSources(data);
        });

        eventSource.addEventListener('complete', () => {
            eventSource.close();
        });

        eventSource.onerror = (e) => {
            console.error('SSE error:', e);
            eventSource.close();
            // Show error state
            document.getElementById('chart-loading').innerHTML = '<span class="text-danger">Failed to load data. Please refresh.</span>';
        };
    }

    // Start SSE connection when page loads
    document.addEventListener('DOMContentLoaded', initSSE);
</script>
}
