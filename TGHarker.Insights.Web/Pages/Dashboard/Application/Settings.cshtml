@page "/dashboard/applications/{applicationId}/settings"
@model TGHarker.Insights.Web.Pages.Dashboard.Application.SettingsModel
@{
    ViewData["Title"] = "Settings";
    Layout = "_DashboardLayout";
}

<div class="page-header mb-4">
    <h4>Settings</h4>
    <p class="page-description">Configure your application settings and get the tracking code for your website.</p>
</div>

<div class="chart-container mb-4">
    <h6 class="mb-3"><i class="bi bi-gear me-2"></i>General</h6>
    <p class="text-muted small mb-3">Update your application's display name and associated domain.</p>
    <form method="post" asp-page-handler="UpdateSettings">
        <div class="mb-3">
            <label class="form-label">Application Name</label>
            <input type="text" class="form-control" name="name" value="@Model.Application?.Name" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Domain</label>
            <input type="text" class="form-control" name="domain" value="@Model.Application?.Domain" required placeholder="example.com">
        </div>
        <button type="submit" class="btn btn-primary">Save Changes</button>
    </form>
</div>

<div class="chart-container mb-4">
    <h6 class="mb-3"><i class="bi bi-code-slash me-2"></i>Tracking Code</h6>
    <p class="text-muted small mb-3">Add this script tag to your website's <code>&lt;head&gt;</code> section to start collecting analytics data. The script is lightweight and won't affect your site's performance.</p>
    <div class="bg-light rounded p-3 font-monospace" style="font-size: 0.8125rem;">
        <code id="trackingCode">&lt;script src="@Model.BaseUrl/sdk/insights.js" data-application="@Model.ApplicationId" insights-target&gt;&lt;/script&gt;</code>
    </div>
    <button class="btn btn-outline-secondary btn-sm mt-2" onclick="copyTrackingCode()">
        <i class="bi bi-clipboard me-1"></i>Copy Code
    </button>
</div>

<div class="chart-container mb-4">
    <h6 class="mb-3"><i class="bi bi-key me-2"></i>Application ID</h6>
    <p class="text-muted small mb-3">Use this unique identifier when integrating with the Insights API or configuring advanced tracking options.</p>
    <div class="bg-light rounded p-3 font-monospace" style="font-size: 0.875rem;">
        <code>@Model.ApplicationId</code>
    </div>
</div>

<div class="chart-container mb-4">
    <h6 class="mb-3"><i class="bi bi-globe me-2"></i>Allowed Origins</h6>
    <p class="text-muted small mb-3">
        Configure which domains can send analytics data. The SDK validates requests based on the origin header.
        Use wildcards like <code>*.example.com</code> to allow all subdomains. Leave empty to allow any origin.
    </p>

    @if (Model.AllowedOrigins.Any())
    {
        <div class="mb-3">
            @foreach (var origin in Model.AllowedOrigins)
            {
                <div class="d-inline-flex align-items-center bg-light rounded px-2 py-1 me-2 mb-2">
                    <code class="me-2">@origin</code>
                    <form method="post" asp-page-handler="RemoveOrigin" class="d-inline">
                        <input type="hidden" name="origin" value="@origin" />
                        <button type="submit" class="btn btn-link btn-sm p-0 text-danger" title="Remove">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </form>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info small mb-3">
            <i class="bi bi-info-circle me-1"></i>
            No allowed origins configured. All origins are currently allowed. Add specific domains to restrict access.
        </div>
    }

    <form method="post" asp-page-handler="AddOrigin" class="d-flex gap-2">
        <input type="text" class="form-control" name="origin" placeholder="https://example.com or *.example.com" style="max-width: 400px;">
        <button type="submit" class="btn btn-outline-primary">
            <i class="bi bi-plus-lg me-1"></i>Add Origin
        </button>
    </form>
</div>

<div class="chart-container mb-4">
    <h6 class="mb-3"><i class="bi bi-person-badge me-2"></i>User Attributes</h6>
    <p class="text-muted small mb-3">Manage which user attributes are available for filtering in the dashboard. Disable attributes that were tracked accidentally or are no longer needed.</p>
    @if (Model.UserAttributes.Any())
    {
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Attribute Key</th>
                    <th>First Seen</th>
                    <th>Last Seen</th>
                    <th class="text-center">Filterable</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var attr in Model.UserAttributes.OrderBy(a => a.Key))
                {
                    <tr>
                        <td><code>@attr.Key</code></td>
                        <td class="text-muted small">@attr.FirstSeen.ToString("MMM d, yyyy")</td>
                        <td class="text-muted small">@attr.LastSeen.ToString("MMM d, yyyy")</td>
                        <td class="text-center">
                            @if (attr.IsFilterable)
                            {
                                <span class="badge bg-success">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No</span>
                            }
                        </td>
                        <td class="text-end">
                            <form method="post" asp-page-handler="ToggleAttribute" class="d-inline">
                                <input type="hidden" name="attributeKey" value="@attr.Key" />
                                <input type="hidden" name="isFilterable" value="@(!attr.IsFilterable)" />
                                @if (attr.IsFilterable)
                                {
                                    <button type="submit" class="btn btn-outline-secondary btn-sm">
                                        <i class="bi bi-eye-slash me-1"></i>Disable
                                    </button>
                                }
                                else
                                {
                                    <button type="submit" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-eye me-1"></i>Enable
                                    </button>
                                }
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="text-center py-4 text-muted">
            <i class="bi bi-inbox fs-3 d-block mb-2"></i>
            No user attributes have been tracked yet. Use <code>Insights.setUserAttributes()</code> to start tracking.
        </div>
    }
</div>

<div class="chart-container" style="border-left: 4px solid #dc3545;">
    <h6 class="mb-3 text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Danger Zone</h6>
    <p class="text-muted small mb-3">Permanently delete this application and all its analytics data including page views, sessions, events, and goals. <strong>This action cannot be undone.</strong></p>
    <form method="post" asp-page-handler="Delete" onsubmit="return confirm('Are you sure you want to delete this application? This action cannot be undone.');">
        <button type="submit" class="btn btn-danger">Delete Application</button>
    </form>
</div>

@section Scripts {
<script>
    function copyTrackingCode() {
        const code = document.getElementById('trackingCode').textContent;
        navigator.clipboard.writeText(code).then(() => {
            alert('Tracking code copied to clipboard!');
        });
    }
</script>
}
